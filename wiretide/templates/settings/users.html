{# templates/settings/users.html #}
<div id="users" class="hidden">
  <h2 class="text-2xl font-semibold mb-4">Users & Roles</h2>

  <!-- Add User Form -->
  <form method="post" action="/api/users" class="space-y-4 max-w-md mb-8">
    <label class="block">
      <span class="text-gray-700 dark:text-gray-200">Username</span>
      <input type="text" name="username" required
             class="mt-1 block w-full rounded border p-2 dark:bg-gray-800 dark:text-white" />
    </label>

    <label class="block">
      <span class="text-gray-700 dark:text-gray-200">Password</span>
      <input type="password" name="password" required
             class="mt-1 block w-full rounded border p-2 dark:bg-gray-800 dark:text-white" />
    </label>

    <label class="block">
      <span class="text-gray-700 dark:text-gray-200">Role</span>
      <select name="role" class="mt-1 block w-full rounded border p-2 dark:bg-gray-800 dark:text-white">
        <option value="admin">Admin</option>
        <option value="user">User</option>
      </select>
    </label>

    <button type="submit"
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
      Add User
    </button>
  </form>

  <!-- User List -->
  <table class="min-w-full text-sm table-auto border mb-8">
    <thead>
      <tr class="bg-gray-100 dark:bg-gray-700 text-left">
        <th class="p-2 border">Username</th>
        <th class="p-2 border">Role</th>
        <th class="p-2 border">Actions</th>
      </tr>
    </thead>
    <tbody id="user-list">
      <!-- Populated by JS -->
    </tbody>
  </table>

  <!-- Roles & Permissions -->
  <div id="roles-container" class="space-y-6">
    <h3 class="text-xl font-semibold mb-3">Role Permissions</h3>
    <!-- Populated dynamically -->
  </div>
</div>

<script>
  async function loadUsers() {
    const res = await fetch("/api/users");
    const users = await res.json();
    const tbody = document.getElementById("user-list");
    tbody.innerHTML = "";
    users.forEach(user => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td class="p-2 border">${user.username}</td>
        <td class="p-2 border">${user.role}</td>
        <td class="p-2 border">
          <form method="post" action="/api/users/delete" onsubmit="return confirm('Delete user ${user.username}?')">
            <input type="hidden" name="username" value="${user.username}" />
            <button type="submit" class="text-red-600 underline">Delete</button>
          </form>
        </td>`;
      tbody.appendChild(row);
    });
  }

  async function loadRoles() {
    const [rolesRes, permsRes] = await Promise.all([
      fetch("/api/roles"),
      fetch("/api/roles/permissions")
    ]);
    if (!rolesRes.ok || !permsRes.ok) {
      document.getElementById("roles-container").innerText = "Failed to load roles or permissions.";
      return;
    }
    const { roles } = await rolesRes.json();
    const { permissions } = await permsRes.json();

    const container = document.getElementById("roles-container");
    container.innerHTML = "<h3 class='text-xl font-semibold mb-3'>Role Permissions</h3>";

    roles.forEach(role => {
      const wrapper = document.createElement("div");
      wrapper.className = "p-4 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 rounded";

      const title = document.createElement("h4");
      title.className = "font-semibold mb-2 text-lg text-gray-800 dark:text-gray-200";
      title.innerText = `Role: ${role.name}`;
      wrapper.appendChild(title);

      const form = document.createElement("form");
      form.method = "POST";
      form.action = `/api/roles/${role.id}/permissions`;

      permissions.forEach(perm => {
        const label = document.createElement("label");
        label.className = "block text-sm text-gray-700 dark:text-gray-300";
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = perm;
        checkbox.className = "mr-2";
        if (role.permissions.includes(perm) || role.permissions.includes("*")) {
          checkbox.checked = true;
        }
        label.appendChild(checkbox);
        label.append(` ${perm}`);
        form.appendChild(label);
      });

      const hiddenInput = document.createElement("input");
      hiddenInput.type = "hidden";
      hiddenInput.name = "permissions";
      form.appendChild(hiddenInput);

      const btn = document.createElement("button");
      btn.type = "submit";
      btn.innerText = "Save Permissions";
      btn.className = "mt-3 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-500";
      form.appendChild(btn);

      form.addEventListener("submit", e => {
        e.preventDefault();
        const checked = Array.from(form.querySelectorAll("input[type=checkbox]:checked"))
            .map(cb => cb.value);
        hiddenInput.value = checked.join(",");
        form.submit();
      });

      wrapper.appendChild(form);
      container.appendChild(wrapper);
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadUsers();
    loadRoles();
  });
</script>

