{% extends "base.html" %}
{% block title %}Router - {{ device.hostname }}{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-4">Router: {{ device.hostname }}</h1>

<div class="bg-white dark:bg-gray-800 p-4 rounded shadow space-y-2">
  <p><strong>MAC:</strong> {{ device.mac }}</p>
  <p><strong>IP:</strong> {{ device.ip }}</p>
  <p><strong>SSH:</strong> {{ "Enabled" if device.ssh_enabled else "Disabled" }}</p>

  <h2 class="text-xl font-semibold mt-4">Configuration</h2>
  <form method="post" action="/clients/router/{{ device.mac }}/update" class="space-y-2">
    <label class="block">
      <span class="text-sm text-gray-700 dark:text-gray-200">Hostname</span>
      <input name="hostname" value="{{ device.hostname }}"
             class="border p-2 rounded w-full dark:bg-gray-700 dark:text-white dark:border-gray-600">
    </label>
    <button type="submit" class="bg-blue-600 dark:bg-blue-500 text-white px-4 py-2 rounded">Save</button>
  </form>

  <!-- Agent update toggle (shown only if global updates are disabled) -->
  <div id="agent-update-control" class="mt-4 hidden">
    <label class="flex items-center space-x-2">
      <input type="checkbox" id="agent-update-toggle" class="form-checkbox h-4 w-4 text-blue-600">
      <span class="text-sm text-gray-700 dark:text-gray-300">Sta agent update toe voor dit apparaat</span>
    </label>
  </div>
</div>

{% if settings %}
  <div class="bg-white dark:bg-gray-800 p-4 mt-6 rounded shadow">
    <h2 class="text-xl font-semibold mb-2">Live Device Status</h2>
    <table class="table-auto border w-full text-sm text-gray-900 dark:text-gray-100">
      <tbody>
        <tr>
          <td class="p-2 border font-medium">Model</td>
          <td class="p-2 border">{{ settings.model or '—' }}</td>
        </tr>
        <tr>
          <td class="p-2 border font-medium">LAN IP</td>
          <td class="p-2 border">{{ device.ip }}</td>
        </tr>
        <tr>
          <td class="p-2 border font-medium">WAN IP</td>
          <td class="p-2 border">{{ settings.wan_ip or '—' }}</td>
        </tr>
        <tr>
          <td class="p-2 border font-medium">DNS Servers</td>
          <td class="p-2 border">
            {% if settings.dns %}
              {{ settings.dns | join(", ") }}
            {% else %}
              —
            {% endif %}
          </td>
        </tr>
        <tr>
          <td class="p-2 border font-medium">Firewall</td>
          <td class="p-2 border">{{ settings.firewall_state.capitalize() if settings.firewall_state else '—' }}</td>
        </tr>
        <tr>
          <td class="p-2 border font-medium">NTP</td>
          <td class="p-2 border">{{ 'Enabled' if settings.ntp_synced else 'Disabled' }}</td>
        </tr>
        <tr>
          <td class="p-2 border font-medium">Last Updated</td>
          <td class="p-2 border">{{ settings.updated_at }}</td>
        </tr>
      </tbody>
    </table>
  </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
  async function loadAgentUpdateToggle(mac) {
    try {
      const globalRes = await fetch("/api/agent-update/settings");
      const globalData = await globalRes.json();
      const globalEnabled = globalData.enabled;

      if (globalEnabled) return; // Per-device toggle niet nodig

      const res = await fetch("/api/devices");
      const devices = await res.json();
      const device = devices.find(d => d.mac === mac);
      if (!device) return;

      document.getElementById("agent-update-control").classList.remove("hidden");
      const checkbox = document.getElementById("agent-update-toggle");
      checkbox.checked = !!device.agent_update_allowed;

      checkbox.addEventListener("change", async () => {
        const enabled = checkbox.checked ? "true" : "false";
        await fetch(`/api/devices/${encodeURIComponent(mac)}/agent-update`, {
          method: "POST",
          body: new URLSearchParams({ enabled })
        });
      });

    } catch (err) {
      console.error("Agent update toggle error:", err);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const mac = "{{ device.mac }}";
    loadAgentUpdateToggle(mac);
  });
</script>
{% endblock %}

