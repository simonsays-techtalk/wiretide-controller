#!/bin/sh /etc/rc.common
# Wiretide Agent init.d service (fixed, no orphans)

START=95
STOP=10
NAME="wiretide-agent"
PROG="/etc/wiretide-agent-run"
PIDFILE="/var/run/$NAME.pid"
LOGFILE="/tmp/wiretide-agent.log"

start() {
    echo "Starting $NAME..."
    mkdir -p /var/run
    "$PROG" >> "$LOGFILE" 2>&1 &
    echo $! > "$PIDFILE"
}

stop() {
    echo "Stopping $NAME..."
    # Kill PID from file AND any other stray wiretide processes
    if [ -f "$PIDFILE" ]; then
        kill "$(cat "$PIDFILE")" 2>/dev/null
        rm -f "$PIDFILE"
    fi
    # Kill all other stray processes
    ps w | grep wiretide-agent-run | grep -v grep | awk '{print $1}' | xargs kill -9 2>/dev/null
}

restart() {
    stop
    sleep 1
    start
}

status() {
    if [ -f "$PIDFILE" ] && kill -0 "$(cat "$PIDFILE")" 2>/dev/null; then
        echo "$NAME is running (PID $(cat "$PIDFILE"))"
    else
        echo "$NAME is not running"
    fi
}

