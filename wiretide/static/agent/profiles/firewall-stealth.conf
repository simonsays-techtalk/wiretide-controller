#!/bin/sh
set -e

#Testing only!!!#

# ==== Pas dit aan indien je LAN-IP anders is ====
LAN_IP="192.168.188.1"

echo "[SSH] Alleen op LAN luisteren"
uci set dropbear.@dropbear[0].Interface='lan'
uci commit dropbear
/etc/init.d/dropbear restart || true

echo "[LuCI/uhttpd] Alleen op LAN-IP luisteren"
uci set uhttpd.main.listen_http="${LAN_IP}:80"
uci set uhttpd.main.listen_https="${LAN_IP}:443"
uci commit uhttpd
/etc/init.d/uhttpd restart || true

echo "[DNS] dnsmasq alleen op LAN"
# Verwijder expliciet WAN/WAN6 uit dnsmasq interfaces, voeg LAN toe
uci del_list dhcp.@dnsmasq[0].interface='wan' 2>/dev/null || true
uci del_list dhcp.@dnsmasq[0].interface='wan6' 2>/dev/null || true
uci add_list dhcp.@dnsmasq[0].interface='lan' 2>/dev/null || true
uci commit dhcp
/etc/init.d/dnsmasq restart || true

echo "[Firewall] WAN input/forward DROP, output ACCEPT (failsafe defaults)"
uci set firewall.@zone[1].input='DROP'
uci set firewall.@zone[1].forward='DROP'
uci set firewall.@zone[1].output='ACCEPT'

# Verwijder typische toestaan-regels op WAN (Ping/IGMP/ICMPv6/DHCPv6/ESP) als die bestaan
# (We zoeken op name en verwijderen die regels als ze er zijn)
for NAME in Allow-Ping Allow-IGMP Allow-ICMPv6-Input Allow-ICMPv6-Forward Allow-DHCPv6 Allow-IPSec-ESP Allow-MLD; do
  IDX=$(uci show firewall | awk -F'[][]' -v n="$NAME" '/=rule/{i=$2} $0 ~ ("name='\''" n "'\''"){print i}')
  [ -n "$IDX" ] && uci delete firewall.@rule[$IDX] || true
done

echo "[Firewall] Expliciet ICMP echo-request op WAN droppen (IPv4)"
uci add firewall.rule >/dev/null
uci set firewall.@rule[-1].name='Drop-ICMP-Echo-WAN-v4'
uci set firewall.@rule[-1].src='wan'
uci set firewall.@rule[-1].proto='icmp'
uci set firewall.@rule[-1].icmp_type='echo-request'
uci set firewall.@rule[-1].family='ipv4'
uci set firewall.@rule[-1].target='DROP'

uci commit firewall
/etc/init.d/firewall restart || true

echo "[UPnP] Uitschakelen indien aanwezig"
if /etc/init.d/miniupnpd enabled 2>/dev/null; then
  /etc/init.d/miniupnpd stop || true
  /etc/init.d/miniupnpd disable || true
fi

echo "âœ… Basis hardening toegepast. WAN is stealth, beheer alleen via LAN (${LAN_IP})."

